---
title: "Boston NPP estimates"
author: "Drew Trlica"
date: "Sept. 28, 2018"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(scipen=999)
knitr::opts_knit$set(root.dir = "E:/FragEVI/")
library(data.table)
library(ggplot2)
library(raster)

```
### Methods (notes)
Due to skewed distributions, median values are reported with upper and lower limits of central 90% of observations.
Unless otherwise noted, the realtionship between biomass gain (stem or area basis) and biomass quantity was modeled as an exponential negative relationship to log-DBH ($growth = e^{a+b \times \log{DBH}}$).



```{r canopy_frag, echo=FALSE, cache=FALSE}
## doing the analysis of 1m cover data is cumbersome here. Importing a summary file from npp_analysis.R instead
cover <- read.csv("E:/FragEVI/processed/boston/bos.lulc.1mcover.summary.csv") ## this is area (ha) sums for different cover by LULC
cover <- cover[,2:7]
cover <- as.data.table(cover)
names(cover) <- c("lulc", "area", "can", "ed", "biom", "isa")

```
### Urban forest structure in Boston
Tree canopy covered `r round(sum(cover$can)/sum(cover$area),2)*100`% of the study area of which `r round(sum(cover$ed)/sum(cover$can), 2)*100`% was within 10 m of an edge, but canopy, biomass, and fragmentation degree were distributed differently between LULC types (*Figure 1*). Developed and High-density Residential areas covering, respectively, `r round(cover[lulc==2, sum(area)]/sum(cover$area), 2)*100`% and `r round(cover[lulc==3, sum(area)]/sum(cover$area), 2)*100`% of the total urban area contained `r round(cover[lulc==2, sum(can)]/sum(cover$can), 2)*100`% and `r round(cover[lulc==3,sum(can)]/sum(cover$can), 2)*100`% of total canopy area of which `r round(cover[lulc==2, sum(ed)]/cover[lulc==2, sum(can)], 2)*100`% and `r round(cover[lulc==3, sum(ed)]/cover[lulc==3, sum(can)], 2)*100`% was within 10 m of an edge (*Table S1 -- canopy and biomass configuration summary*). In contrast, while Forest areas covered only `r round(cover[lulc==1, sum(area)]/sum(cover$area), 2)*100`% of the study area they contained `r round(cover[lulc==1, sum(can)]/sum(cover$can), 2)*100`% of the total urban canopy and `r round(cover[lulc==1, sum(biom)]/sum(cover$biom), 2)*100`% of total biomass, of which only `r round(cover[lulc==1, sum(ed)]/cover[lulc==1, sum(can)], 2)*100`% was within 10 m of an edge. The extensive area of HD Residential land, containing a significant fraction of the total city biomass under highly fragmented conditions, implies a potentially large contribution of these types of canopy configurations to overall urban "forest" productivity, but which also requires specific accounting for urban- and canopy-specific influence on growth rates. In contrast, Forest-type land cover covered a small fraction of total land surface but contained a significant fraction of overall biomass and at much lower canopy fragmentation than other developed cover types. These relatively small areas of forest might as a result be expected to perform a significant proportion of total C uptake for the city, but under different growing conditions and uptake rates than in surrounding urban trees.
```{r fig_1, echo=FALSE, out.width='100%'}
knitr::include_graphics('E:/FragEVI/images/Fig1_overview_v1_cr.png')
```

```{r growth_dbh, echo=FALSE, warning=FALSE, message=FALSE}
## stem data
library(tidyverse)
library(lme4)
live <- as.data.table(read.csv("processed/fia.live.stem.dbh.growth.csv"))
andy <- as.data.table(read.csv("processed/andy.bai.dbh.pseudo.csv"))
street <- as.data.table(read.csv("processed/boston/street.trees.dbh.csv"))

## models ## just slot in whatever is the best model when you decide on it
load("processed/mod.fia.final.sav")
load("processed/mod.andy.final.sav")
load("processed/mod.street.final.sav")
mfia <- summary(mod.fia.final)
p.andy <- drop1(mod.andy.final, test="Chisq")
# p.andy[3,4]
s.andy <- summary(mod.andy.final)
mstreet <- summary(mod.street.final)

### plot level data/models
live.plot <- as.data.table(read.csv("processed/fia.live.plot.groomed.csv"))
load("processed/mod.live.plot.final.sav")
mfia.plot <- summary(mod.live.plot.final)
andy.plot <- as.data.table(read.csv("processed/andy.plot.groomed.csv"))
load("processed/mod.andy.plot.final.sav")
mandy.plot <- summary(mod.andy.plot.final)
### to get the formatting of p values printed out right
p.fixer <- function(x){
  if(x<0.001){
    return(0.001)
  }else if(nchar(as.character(x))<5){
    d <- str_pad(as.character(x), width = 5, pad=0, side="right")
    return(d)
    } else{
      return(round(x, 3))
    }
}
```

### Growth rates in urban context
On an individual stem basis, urban trees grew more quickly and showed increased growth nearer to canopy edges (*Figure 2*). Rural forest trees grew more slowly than urban forest trees, with median DBH `r paste(round(live[,median(DIAM_T0, na.rm=T)], digits=1), " (", round(live[,quantile(DIAM_T0, probs=c(0.05))], 1), "-", round(live[,quantile(DIAM_T0, probs=c(0.95))], 1), ")", sep="")` cm corresponding to median annual growth of `r paste(round(live[,median(growth.ann.rel, na.rm=T)], digits=3), " (", round(live[,quantile(growth.ann.rel, probs=c(0.05))], 3), "-", round(live[,quantile(growth.ann.rel, probs=c(0.95))], 3), ")", sep="")` kg/kg. The best fit model for rural stem growth rate (*Table S2 -- model coefficients and p values*) (residual std. error `r round(mfia$sigma, 3)`) showed a significant negative relationship with log-DBH (p<`r p.fixer(mfia$coefficients[2,4])`) and a significantly higher per-stem rate of growth in softwood species compared to hardwoods (p<`r p.fixer(mfia$coefficients[3,4])`). On an areal basis, complete DBH measurements over 4.8 years in all rural forest trees >12 cm DBH showed a comparble significant negative exponential relationship (residual standard error (RSE) `r round(mfia.plot$sigma, 3)`) between annual hardwood biomass gain (MgC per MgC/ha) and total biomass density (MgC/ha) (p<`r p.fixer(mfia.plot$coefficients[2,4])`), excluding plots with <25% hardwoods by total biomass (*Figure S1 -- plot level growth*). Median areal growth rate in hardwood species in rural forest plots was `r paste(round(live.plot[,median(biom.growth.ann.hw, na.rm=T)], digits=3), " (", round(live.plot[,quantile(biom.growth.ann.hw, probs=c(0.05))], 3), "-", round(live.plot[,quantile(biom.growth.ann.hw, probs=c(0.95))], 3), ")", sep="")` MgC per MgC/ha, corresponding to median biomass denstiy of `r paste(round(live.plot[,median(total.biom0.MgC.ha, na.rm=T)], digits=1), " (", round(live.plot[,quantile(total.biom0.MgC.ha, probs=c(0.05))], 1), "-", round(live.plot[,quantile(total.biom0.MgC.ha, probs=c(0.95))], 1), ")", sep="")` MgC/ha.

Trees in urban forest grew faster than in rural forest, and grew more quickly within 10 m of a canopy edge than in canopy interior (20-30 m). Median DBH of edge (<10 m) and interior stems was `r round(andy[seg.Edge=="E", median(dbh.start, na.rm=T)], digits=1)` cm and `r round(andy[seg.Edge=="I", median(dbh.start, na.rm=T)], digits=1)` cm, respectively, corresponding to median annual growth of `r round(andy[seg.Edge=="E", median(biom.rel.ann, na.rm=T)], digits=3)` kg/kg and `r round(andy[seg.Edge=="I", median(biom.rel.ann, na.rm=T)], digits=3)` kg/kg. The best fit model for urban forest stem growth rate (estimating random slopes and intercepts for sample plot, year interval, and stem ID) showed a significant negative relationship with log-DBH (p<`r p.fixer(p.andy[2,4])`) and a significantly lower growth rate in interior-grown stems (p<`r p.fixer(p.andy[3,4])`). Projecting these stem growth rates to the record of all stems >5 cm DBH by edge distance class in the urban forest plots, there was a corresponding significant linear relationship (RSE `r round(mandy.plot$sigma, 3)`) an an areal basis between annual biomass gain and biomass density (p<`r p.fixer(mandy.plot$coefficients[2,4])`), with significant lower biomass gain overall in interior plots (p< `r p.fixer(mandy.plot$coefficients[3,4])`). In the urban forest plots median areal growth rate in edge biomass was `r paste(round(andy.plot[seg.F=="E",median(rel.gain.ps, na.rm=T)], digits=3), " (", round(andy.plot[seg.F=="E",quantile(rel.gain.ps, probs=c(0.05))], 3), "-", round(andy.plot[seg.F=="E",quantile(rel.gain.ps, probs=c(0.95))], 3), ")", sep="")` MgC per MgC/ha, corresponding to median edge biomass denstiy of `r paste(round(andy.plot[seg.F=="E",median(biom.MgC.ha, na.rm=T)], digits=1), " (", round(andy.plot[seg.F=="E",quantile(biom.MgC.ha, probs=c(0.05))], 1), "-", round(andy.plot[seg.F=="E",quantile(biom.MgC.ha, probs=c(0.95))], 1), ")", sep="")` MgC/ha. In contrast, in interior biomass median areal growth rate was `r paste(round(andy.plot[seg.F=="I",median(rel.gain.ps, na.rm=T)], digits=3), " (", round(andy.plot[seg.F=="I",quantile(rel.gain.ps, probs=c(0.05))], 3), "-", round(andy.plot[seg.F=="I",quantile(rel.gain.ps, probs=c(0.95))], 3), ")", sep="")` MgC per MgC/ha, corresponding to median interior biomass denstiy of `r paste(round(andy.plot[seg.F=="I",median(biom.MgC.ha, na.rm=T)], digits=1), " (", round(andy.plot[seg.F=="I",quantile(biom.MgC.ha, probs=c(0.05))], 1), "-", round(andy.plot[seg.F=="I",quantile(biom.MgC.ha, probs=c(0.95))], 1), ")", sep="")` MgC/ha.

Stem growth rate was fastest in street trees, with median annual growth rate of `r round(street[record.good==1 & dbh.2006>5, median(npp.ann.rel, na.rm=T)], digits=3)` kg/kg corresponding to median DBH of `r round(street[record.good==1 & dbh.2006>5, median(dbh.2006, na.rm=T)], digits=1)`. As in the other tree stem samples, the best fit model for street tree stem growth (RSE `r round(mstreet$sigma, 3)`) showed a significant negative relationship with log-DBH (p<`r p.fixer(mstreet$coefficients[2,4])`). The sampling design of the street tree survey did not allow for these growth rates to be estimated on an areal basis as in the rural- and urban-forest samples, necessitating the simulation of indvidual stem assemblages to approximate biomass and productivity by cell across the study area. *Is it worth presenting some aggregate stats on the simulated street tree results here?*

**Context** How things compare to other measured rates in literature etc. The range and median stem DBH in each sample context were similar, but the street tree sample included very few conifers and a relatively large fraction of non-native taxa, primarily deciduous hardwoods including members of *Gleditsia*, *Zelkova* and *Pyrus*.

```{r fig_2, echo=FALSE, out.width='100%'}
knitr::include_graphics('E:/FragEVI/images/Fig2A_stem-dbh-growth_mono_logxform.png')
```

```{r npp_summary, echo=FALSE}
npp.dat <- as.data.table(read.csv("E:/FragEVI/processed/npp.estimates.V4.csv"))

```
#### Estimates of biomass gain
Estimated biomass gain (MgC/yr) in the combined urban forest + street tree (Hybrid) model was `r round(npp.dat[aoi>800, sum(hyb.npp.mod.lin, na.rm=T)/2000],0)` MgC, with the largest annual biomass gains accruing in the Forest and HD Residential land use types (*Table 1*). In contrast, estimates of biomass growth rates made only on the basis of urban forest growth rates (including edge effects) predicted somewhat lower total biomass gain of `r round(npp.dat[aoi>800, sum(andy.npp.tot.mod.lin, na.rm=T)/2000], 0)` MgC. The Hybrid model showed greater biomass accural primarily to non-forested land use types like High-Density Residential, partly a result of accounting for biomass growth in these open-canopy areas by applying higher street tree-like growth factors. An estimation approach that applied rural forest growth factors to per-ha-canopy biomass density showed lower biomass gain in all land use categories (total gain of `r round(npp.dat[aoi>800, sum(fia.empir.npp.kg.hw.forest, na.rm=T)/2000], 0)`) MgC, with a greater relative fraction of total biomass gain accruing to forest stands. This reduced estimate, particuarly in non-forested cover types, is partly the result of lower per-stem and per-area biomass gain in rural forest context than seen in urban forest or street trees. The Hybrid estimate apportioned biomass gains similarly to the distribution of total biomass across the study area, with most biomass gains occuring in the more common moderate-density pixels dominated by the open-canopy High-Density Residential type with higher street tree-like growth factors (*Figure 3*). The rural forest model, in contrast, applied lower rural forest-like growth factors overall and apportioned somewhat more total biomass gain into the less common high-density pixels dominated by Forest land cover type.  

```{r fig_3, echo=FALSE, out.width='100%'}
knitr::include_graphics('E:/FragEVI/images/Fig4_biom-dens_NPP_comb.png')
```

### Effect of biomass density basis 
The model results also illustrate the sensitivity of estimating biomass productivity to the method used to judge biomass density in heterogeneous scattered urban tree stands. (Say something about *Figure 4 cartoon*). The method of determining the areal basis (ground, canopy, or pervious area) for biomass density had significant and differential effects on biomass density distributions that varied with land use type (*Figure S2*). As this study used the empirical relationship between stand biomass density and productivity on an areal basis to estimate biomass gain from measured density in the study area, different estimates of biomass density can be expected to result in different estimates of biomass gain. For instance, in comparison to the results obtained via per-canopy-area biomass density estimates, applying rural forest growth factors to biomass density on a per-ground-area basis rendered an estimate of `r round(npp.dat[aoi>800, sum(andy.npp.tot.mod.lin, na.rm=T)/2000], 0)`, reasonably similar to the estimate obtained using edge-specific urban forest growth factors. These coinciding results, rather than reflecting similar underlying ecosystem processes, are instead an artifact of shifting the distribution of biomass density, when judged on this per-ground-area basis, generally lower due to the prevalence of discontinuous tree stands. Without accounting for canopy coverage and spacing, the commonplace urban example of stands of discontinuous canopy with relatively mature large trees appears similar in density to younger lower-biomass stands of smaller trees spread evenly over the same area. Such stands in continuous forest context tend to grow relatively more quickly than more mature stands, and in the case of the Boston study area the relatively high frequency of discontinous stands with low- to moderate biomass density on a per-ground-area basis raised the overall estimate of total biomass gain. This example shows that uncritically mapping the growth to density relationship of continuous forests on onto discontinous urban tree stands lead to applying higher growth factors than are likely accurate. 

## Conclusions
Estimating forest productivity in urban areas often requires reliance on incomplete or infrequent field survey, or coarse-resolution remote sensing measurements that obscure heterogeneity in urban tree stands with meaningful ecosystem functional consequences, such as canopy edges. Difficulties in accurately estimating forest productivity in urban context may also be due to two general types of ambiguity: The fundamental relationship between tree size and productivity measured in rural forest stands may not be reflected in urban-grown trees that experience different canopy environments, nutrient inputs, and a host of other anthropogenic effects not present in rural forests. To address this ambituity, this work has attempted to apply size-to-growth-rate relationships that were measured in local urban-grown trees that may more accurately represent forest ecosystem processes at work in the local urban context. The second ambiguity is in the application of biomass density-to-productivity relationships to discontinous and heterogenous collections of urban trees that may apply clearly only to less intensively managed and impacted stands of continuous canopy trees at predictable stages of succession. Such approaches are commonly practice to inventory C sequestration and annual uptake in rural forests, based on the predictable relationship between stand age (density) and C uptake (e.g. FIA COLE). Ecosystem carbon uptake estimates often use biomass density (or stand age) as a proxy for productivity based on the fundamental relationship of individual stem size to productivity. Thus even if accurate and reasonably spatially resolved inventories of forest carbon by area were available for a city, the inability to adequately quantify "density" in an ecosystem functional sense would still produce difficulties in producing accurate estimates of C uptake. 

Therefore you should be careful and do it the way we did it.

As growth and C uptake in forest stands is very often predicted on the basis of biomass density (also a proxy for stand age), these ambiguities in the call for caution in selecting an appropriate method for ascertiaining biomass density, particularly in scattered open-canopy urban stands.


```{r fig_S1, echo=FALSE, out.width='66%'}
knitr::include_graphics('E:/FragEVI/images/FigS1_plot_level_growth.png')
```


